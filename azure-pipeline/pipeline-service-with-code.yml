trigger:
  branches:
    include:
      - development
      - qc
      - release
      - master
  paths:
    include:
      - "*"
    exclude:
      - "*.yml"

pool: "BTG Colombia - Azure DevOps"

resources:
  repositories:
    - repository: devops-templates
      type: git
      name: devops-templates
      ref: master

variables:
  - name: stage
    ${{ if eq(variables['Build.SourceBranchName'], 'development') }}:
      value: dev
    ${{ elseif eq(variables['Build.SourceBranchName'], 'release') }}:
      value: uat
    ${{ elseif eq(variables['Build.SourceBranchName'], 'master') }}:
      value: pdn
  - name: region
    value: us-east-1
  - name: awsCredentials
    value: SERVICE-${{upper(variables.stage)}}

  - group: group-tags
  - group: group
  - group: group-${{variables.stage}}
  # Need for services != serverless
  - name: cfBucketName
    value: btg.${{variables.stage}}.ACCOUNT.cloudformation
  # Need for services == ecs
  - name: version
    value: $(Build.BuildNumber)
  - name: pythonVersion #Optional - only for python code
    value: '3.9'

stages:
  - template: main.yml@devops-templates
    parameters:
      service: ecr
      resource: repo
      key: $(serviceName)
      code: resources
  # Variables need mainProject var: project deploy ecs main with key = infra
  # Need serviceName var = key
  # TaskRole deploy in project-resources: ${project}-resources-${stage}-${serviceName}RoleARN
  - template: main.yml@devops-templates
    parameters:
      service: ecs
      resource: service
      key: $(serviceName)
      code: node
      type: server-client
      workPath: $(System.DefaultWorkingDirectory)/front/server
